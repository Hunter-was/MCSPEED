<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, limit } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD01lZzZiuyzHUHnIdt3CGWd82kGq5GOq0",
        authDomain: "mcspeeddot.firebaseapp.com",
        projectId: "mcspeeddot",
        storageBucket: "mcspeeddot.firebasestorage.app",
        messagingSenderId: "592845974193",
        appId: "1:592845974193:web:91fd5974ca6cd68dafd090"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // AUTH ACTIONS
    document.getElementById('showSignup').onclick = () => document.getElementById('signup-section').style.display = 'block';
    
    document.getElementById('registerBtn').onclick = async () => {
        const name = document.getElementById('regName').value;
        const email = document.getElementById('regEmail').value;
        const pass = document.getElementById('regPass').value;
        try {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await updateProfile(res.user, { displayName: name });
            location.reload();
        } catch (e) { alert(e.message); }
    };

    document.getElementById('loginBtn').onclick = () => {
        signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value).catch(e => alert(e.message));
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('auth-ui').innerHTML = `<span>${user.displayName || user.email}</span><button id="realLogout" class="btn" style="background:#cc3300; margin-left:10px;">Logout</button>`;
            document.getElementById('realLogout').onclick = () => signOut(auth).then(() => location.reload());
            
            // Corrected admin email list
            const admins = ["rowankehoe@gmail.com", "consider.boarding.school@gmail.com"];
            if (admins.includes(user.email)) {
                document.getElementById('adminPanel').style.display = 'block';
            }
        }
    });

    // SUBMIT TO FORMSPREE (USER SIDE)
    document.getElementById('submitBtn').onclick = async () => {
        if (!auth.currentUser) return alert("Log in first!");
        const data = {
            player: auth.currentUser.displayName,
            category: document.getElementById('submitCategory').value,
            time: document.getElementById('runTime').value,
            video: document.getElementById('runVideo').value
        };
        try {
            const res = await fetch("https://formspree.io/f/mlgwzjob", { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(data) 
            });
            if (res.ok) alert("Sent to mods! Check your email.");
        } catch (e) { alert("Formspree Error: " + e.message); }
    };

    // MODERATOR APPROVAL (ADMIN SIDE - SAVES TO FIREBASE)
    document.getElementById('modApproveBtn').onclick = async () => {
        try {
            await addDoc(collection(db, "runs"), {
                player: document.getElementById('modPlayer').value,
                time: document.getElementById('modTime').value,
                video: document.getElementById('modVideo').value,
                category: document.getElementById('modCategory').value,
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date()
            });
            alert("SUCCESS: Run Published Live!");
            location.reload(); // Refresh to see the new data
        } catch (e) {
            console.error(e);
            alert("DATABASE FAIL: " + e.message);
        }
    };

    // LIVE LEADERBOARD (WITH FILTER)
    const loadBoard = (cat) => {
        // This query requires an INDEX in Firebase Console
        const q = query(collection(db, "runs"), where("category", "==", cat), orderBy("time", "asc"));
        
        onSnapshot(q, (snap) => {
            const body = document.getElementById('boardBody');
            body.innerHTML = ""; let rank = 1;
            snap.forEach(doc => {
                const r = doc.data();
                body.innerHTML += `<tr><td>${rank++}</td><td>${r.player}</td><td>${r.time}</td><td>${r.date}</td><td><a href="${r.video}" target="_blank" style="color:#3e8e41">Link</a></td></tr>`;
            });
        }, (error) => {
            console.error("Snapshot error:", error);
            // If the table is empty, this alert will tell you why (usually missing index)
            if(error.message.includes("index")) {
                alert("Leaderboard Error: You need to create a 'Composite Index' in Firebase. Check the F12 Console for the link.");
            }
        });
    };
    
    document.getElementById('categorySelect').onchange = (e) => loadBoard(e.target.value);
    loadBoard("Any% Glitchless (F3)");

    // FORUM
    document.getElementById('postBtn').onclick = async () => {
        if (!auth.currentUser) return alert("Log in!");
        await addDoc(collection(db, "forum"), { user: auth.currentUser.displayName, text: document.getElementById('forumInput').value, timestamp: new Date() });
        document.getElementById('forumInput').value = "";
    };
    onSnapshot(query(collection(db, "forum"), orderBy("timestamp", "desc"), limit(15)), (snap) => {
        const container = document.getElementById('forum-container');
        container.innerHTML = "";
        snap.forEach(doc => {
            const p = doc.data();
            container.innerHTML += `<div class="forum-box"><strong>${p.user}:</strong> ${p.text}</div>`;
        });
    });
</script>
